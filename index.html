<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Operator Performance Report</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 18px; background:#f7fafc; color:#111; }
    h2 { margin: 0 0 12px; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    input[type="date"], select { padding:8px 10px; border-radius:6px; border:1px solid #d1d5db; }
    button { padding:9px 12px; background:#2563eb; color:#fff; border:0; border-radius:8px; cursor:pointer; font-weight:600; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .card { background:#fff; padding:14px; border-radius:10px; border:1px solid #e6e9ef; margin-bottom:14px; }

    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
    th, td { padding:8px; text-align:center; }

    /* Report header */
    .report-header { border:1px solid #000; border-radius:6px; padding:10px 20px; margin-bottom:20px; background:#fff; }
    .header-top { display:flex; justify-content:space-between; align-items:center; }
    .header-top img { max-height:60px; width:auto; }
    .header-center { text-align:center; flex:1; }
    .header-center h1 { margin:0; font-size:22px; font-weight:bold; }
    .header-center h3 { margin:4px 0 0; font-size:14px; font-weight:normal; }
    .header-center h2 { margin:6px 0 0; font-size:18px; font-weight:bold; }
    .header-bottom { display:flex; justify-content:space-between; font-size:13px; margin-top:6px; font-weight:bold; }

    /* Screenshot-like styling */
    .kpiTable, .gridTable { border:2px solid #555; }
    .kpiTable th, .kpiTable td, .gridTable th, .gridTable td { border:1px solid #555; }
    .kpiTable thead tr, .gridTable thead tr { background:#e5e7eb; font-weight:700; }
    .kpiTable td { height:34px; }

    .muted { color:#6b7280; font-size:13px; }
    .small { font-size:12px; color:#6b7280; }
    .error { color:#991b1b; background:#fff1f2; padding:8px; border-radius:6px; border:1px solid #fecaca; margin-top:8px; display:none; }
    pre { background:#f3f4f6; padding:8px; border-radius:6px; overflow:auto; max-height:180px; display:none; }
  </style>
</head>
<body>

  <!-- Date Selection -->
  <div class="controls">
    <label for="datePicker">Date</label>
    <input id="datePicker" type="date" />
    <label for="operatorSelect">Operator</label>
    <select id="operatorSelect"><option value="">-- Select Operator --</option></select>
    <button id="generateBtn">Generate</button>
    <div id="status" class="small muted" style="margin-left:12px"></div>
  </div>

  <!-- Report Section -->
  <div id="reportSection" style="display:none;">
    <div class="report-header" id="reportHeader">
      <div class="header-top">
        <img src="PlantwizLogo.png" alt="Plantwiz Logo">
        <div class="header-center">
          <h1>Pima Controls Pvt. Ltd</h1>
          <h3>Block No.298, Nr.Bacha Motors, Sanathal Cross Road, Ahmedabad(382210)</h3>
          <h2>Operator Performance Report</h2>
        </div>
        <img src="PimaLogo.png" alt="Pima Logo">
      </div>
      <div class="header-bottom">
        <span id="headerDate">Date: --</span>
        <span id="headerOperator">Operator Name: --</span>
        <span id="generatedDate">Report Generated ON: --</span>
      </div>
    </div>

    <div id="errorBox" class="error"></div>
    <div id="reportOutput"></div>
    <pre id="debugOutput"></pre>
  </div>

  <script>
    /* -------- Config -------- */
    const DEVICE_ID = "991cf500-661a-11f0-90f1-775fee303094";
    const API_BASE = "https://plantwiz.pimateck.in/api";
    const qs = new URLSearchParams(window.location.search);
    const TOKEN = qs.get('token') || "";

    /* -------- DOM -------- */
    const datePicker = document.getElementById('datePicker');
    const operatorSelect = document.getElementById('operatorSelect');
    const btnGenerate = document.getElementById('generateBtn');
    const status = document.getElementById('status');
    const errorBox = document.getElementById('errorBox');
    const reportSection = document.getElementById('reportSection');
    const reportOutput = document.getElementById('reportOutput');
    const debugOutput = document.getElementById('debugOutput');

    /* -------- Utils -------- */
    function showError(msg) {
      if (!msg) { errorBox.style.display = 'none'; errorBox.textContent = ''; return; }
      errorBox.style.display = 'block'; errorBox.textContent = msg;
    }
    function setStatus(txt) { status.textContent = txt || ''; }
    function safeNum(v) {
      if (v === undefined || v === null) return NaN;
      const n = typeof v === 'number' ? v : parseFloat(String(v).replace(',', ''));
      return Number.isFinite(n) ? n : NaN;
    }
    function normalizeToMinute(ts) {
      const d = new Date(+ts); d.setSeconds(0,0); return d.getTime();
    }

    /* -------- Keys -------- */
    const KEYS_LIST = [
      "SKU","Operator_Name","Machine_Speed","Standard_Speed",
      "Runtime","Downtime","Idletime",
      "Good_Production","Planned_Production_Time",
      "deltaperformance","deltaavailability","deltaoee","deltaquality"
    ];
    const KEYS_PARAM = KEYS_LIST.join(',');

    /* -------- Data layer -------- */
    async function fetchTelemetryForDate(dateStr) {
      if (!TOKEN) throw new Error("Missing token in URL (?token=YOUR_JWT)");
      const start = new Date(dateStr + "T00:00:00").getTime();
      const end   = new Date(dateStr + "T23:59:59").getTime();
      const url = `${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${encodeURIComponent(KEYS_PARAM)}&startTs=${start}&endTs=${end}&interval=60000&limit=5000`;
      const res = await fetch(url, { headers: { "X-Authorization": `Bearer ${TOKEN}` } });
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        throw new Error(`Telemetry fetch failed: ${res.status} ${txt}`);
      }
      return res.json();
    }

    function buildRowsFromTimeseries(tsObj) {
      const map = new Map();
      Object.entries(tsObj || {}).forEach(([key, arr])=>{
        (arr||[]).forEach(p=>{
          const minute = normalizeToMinute(p.ts);
          const row = map.get(minute) || { ts: minute };
          row[key] = p.value;
          map.set(minute, row);
        });
      });
      return Array.from(map.values()).sort((a,b)=>a.ts-b.ts);
    }

    async function loadOperators(dateStr) {
      try {
        showError(''); setStatus('Loading operators…');
        operatorSelect.innerHTML = '<option value="">Loading…</option>';
        const ts = await fetchTelemetryForDate(dateStr);
        const ops = (ts.Operator_Name || []).map(x => String(x.value).trim()).filter(Boolean);
        const unique = [...new Set(ops)];
        operatorSelect.innerHTML = '<option value="">-- Select Operator --</option>';
        unique.forEach(op => operatorSelect.appendChild(new Option(op, op)));
        setStatus(unique.length ? `Found ${unique.length} operator(s)` : 'No operators found');
      } catch (err) {
        operatorSelect.innerHTML = '<option value="">-- Select Operator --</option>';
        showError(err.message || String(err)); setStatus('');
      }
    }

    /* -------- Report -------- */
    btnGenerate.addEventListener('click', generateReport);
    datePicker.addEventListener('change', () => { setStatus(''); showError(''); if (datePicker.value) loadOperators(datePicker.value); });

    (function initToday(){
      const d = new Date();
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
      datePicker.value = `${y}-${m}-${day}`;
      if (datePicker.value) loadOperators(datePicker.value).catch(()=>{});
    })();

    async function generateReport() {
      showError(''); reportOutput.innerHTML = ''; debugOutput.style.display = 'none';

      const dateStr = datePicker.value;
      const operator = operatorSelect.value;
      if (!dateStr) { showError('Please select a date.'); return; }
      if (!operator) { showError('Please select an operator.'); return; }

      // Show header
      reportSection.style.display = 'block';
      document.getElementById('headerDate').textContent = `Date: ${dateStr}`;
      document.getElementById('headerOperator').textContent = `Operator Name: ${operator}`;
      document.getElementById('generatedDate').textContent = `Report Generated ON: ${new Date().toLocaleString()}`;

      try {
        setStatus('Fetching telemetry and computing…');
        const ts = await fetchTelemetryForDate(dateStr);
        const rows = buildRowsFromTimeseries(ts);

        // Only selected operator
        const opRows = rows.filter(r => (r.Operator_Name ? String(r.Operator_Name).trim() : '') === operator);
        if (!opRows.length) {
          reportOutput.innerHTML = `<div class="card"><div class="muted">No records found for ${operator} on ${dateStr}.</div></div>`;
          setStatus(''); return;
        }

        // Aggregations
        let plannedProduction = 0, actualProduction = 0, goodProduction = 0;
        let totalRuntime = 0, totalDowntime = 0, plannedTime = 0;
        let sumPerf = 0, cntPerf = 0, sumAvail = 0, cntAvail = 0, sumOee = 0, cntOee = 0, sumQual = 0, cntQual = 0;

        opRows.forEach(r => {
          const std = safeNum(r.Standard_Speed);
          const ms  = safeNum(r.Machine_Speed);
          const gp  = safeNum(r.Good_Production);
          const rt  = safeNum(r.Runtime);
          const dt  = safeNum(r.Downtime);

          if (Number.isFinite(std)) plannedProduction += std;
          if (Number.isFinite(ms))  actualProduction  += ms;
          if (Number.isFinite(gp))  goodProduction    += gp;

          if (Number.isFinite(rt)) totalRuntime += rt;      // minutes
          if (Number.isFinite(dt)) totalDowntime += dt;     // minutes

          const ppt = safeNum(r.Planned_Production_Time);
          if (Number.isFinite(ppt)) plannedTime = ppt;      // keep latest/last

          const dperf = safeNum(r.deltaperformance);  if (Number.isFinite(dperf)) { sumPerf += dperf; cntPerf++; }
          const dav   = safeNum(r.deltaavailability); if (Number.isFinite(dav))   { sumAvail += dav; cntAvail++; }
          const doee  = safeNum(r.deltaoee);          if (Number.isFinite(doee))  { sumOee  += doee;  cntOee++; }
          const dqual = safeNum(r.deltaquality);      if (Number.isFinite(dqual)) { sumQual += dqual; cntQual++; }
        });

        const avgPerf = cntPerf ? (sumPerf/cntPerf) : NaN;
        const avgAvail = cntAvail ? (sumAvail/cntAvail) : NaN;
        const avgOee = cntOee ? (sumOee/cntOee) : NaN;

        // Quality: prefer deltaquality avg; fallback to computed
        const computedQuality = actualProduction > 0 ? (goodProduction / actualProduction * 100) : NaN;
        const displayQuality = cntQual ? (sumQual/cntQual) : computedQuality;

        // Build HTML for the screenshot-like section
        let html = `<div class="card"><h3>3. Machine Performance Summary</h3>`;

        // KPI Row table
        html += `
          <table class="kpiTable">
            <thead>
              <tr><th>OEE</th><th>Performance</th><th>Availability</th><th>Quality</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>${Number.isFinite(avgOee) ? avgOee.toFixed(0)+'%' : '--'}</td>
                <td>${Number.isFinite(avgPerf) ? avgPerf.toFixed(0)+'%' : '--'}</td>
                <td>${Number.isFinite(avgAvail) ? avgAvail.toFixed(0)+'%' : '--'}</td>
                <td>${Number.isFinite(displayQuality) ? Number(displayQuality).toFixed(0)+'%' : '--'}</td>
              </tr>
            </tbody>
          </table>`;

        // Three-column grid table (labels inside cells)
        html += `
          <table class="gridTable" style="margin-top:14px;">
            <thead>
              <tr><th>Performance</th><th>Availability</th><th>Quality</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Planned Production: ${Number.isFinite(plannedProduction) ? plannedProduction.toLocaleString() : '--'}</td>
                <td>Planned Production Time: ${Number.isFinite(plannedTime) ? plannedTime.toFixed(0) : '--'} min</td>
                <td>Actual Production: ${actualProduction.toLocaleString()}</td>
              </tr>
              <tr>
                <td>Actual Production: ${actualProduction.toLocaleString()}</td>
                <td>Runtime: ${(totalRuntime).toFixed(0)} min</td>
                <td>Good Production: ${goodProduction.toLocaleString()}</td>
              </tr>
              <tr>
                <td></td>
                <td>Downtime: ${(totalDowntime).toFixed(0)} min</td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>`;

        reportOutput.innerHTML = html;
        setStatus(`Report ready — rows used: ${opRows.length}`);

        // optional debug block
        debugOutput.style.display = 'none';
        debugOutput.textContent =
`Counts → perf:${cntPerf}, avail:${cntAvail}, oee:${cntOee}, qual:${cntQual}
Totals → planned:${plannedProduction}, actual:${actualProduction}, good:${goodProduction}
Time → runtime(min):${totalRuntime}, downtime(min):${totalDowntime}, plannedTime(min):${plannedTime}`;
      } catch (err) {
        showError(err.message || String(err));
        setStatus('');
      }
    }
  </script>
</body>
</html>
