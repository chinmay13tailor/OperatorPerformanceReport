<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Operator Performance Report</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Gauges -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- PDF export deps -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand: #2563eb;           /* primary (blue) */
      --brand-600:#1e40af;
      --accent:#0ea5e9;           /* secondary accent (cyan) */
      --ok:#16a34a;               /* green */
      --warn:#f59e0b;             /* amber */
      --bad:#dc2626;              /* red */
      --ink:#0f172a;              /* dark text */
      --muted:#64748b;            /* muted text */
      --paper:#ffffff;
      --panel:#f8fafc;            /* page bg */
      --line:#e5e7eb;             /* border */
      --thead:#eef2ff;            /* table head bg */
      --thead-border:#c7d2fe;
      --stripe:#fafafa;           /* row stripe */
      --shadow: 0 6px 18px rgba(16,24,40,.06);
      --radius: 14px;
      --radius-sm:10px;
    }

    /* Page */
    html, body { height: 100%; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      padding: 18px;
      background: radial-gradient(1500px 550px at 10% -20%, #e5f3ff 0%, transparent 60%) no-repeat,
                  radial-gradient(1200px 450px at 90% -10%, #eafaf6 0%, transparent 60%) no-repeat,
                  var(--panel);
      color: var(--ink);
    }
    .container { max-width: 1100px; margin: 0 auto; }

    /* Controls */
    h2 { margin: 0 0 12px; }
    .controls {
      display:flex; gap:10px; align-items:end; flex-wrap:wrap; margin-bottom:18px;
      background: var(--paper);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    label { font-size:12px; color:var(--muted); display:block; margin:0 0 4px; }
    input[type="date"], select {
      padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#fff;
      box-shadow: inset 0 1px 1px rgba(0,0,0,.03);
      min-width: 180px;
    }
    button {
      padding:11px 14px; background:linear-gradient(180deg, var(--brand) 0%, var(--brand-600) 100%);
      color:#fff; border:0; border-radius:10px; cursor:pointer; font-weight:600;
      letter-spacing:.2px; box-shadow: 0 6px 14px rgba(37, 99, 235, .25);
    }
    button.secondary {
      background: #fff; color: var(--brand); border:1px solid var(--brand);
      box-shadow:none;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .small { font-size:12px; color:var(--muted); }

    /* Cards / Sections */
    .card {
      background: var(--paper); padding:16px; border-radius: var(--radius);
      border:1px solid var(--line); margin-bottom:16px; box-shadow: var(--shadow);
    }
    .section-title{
      display:flex; align-items:center; gap:10px; margin:0 0 12px;
      font-size:18px;
    }
    .section-title::before{
      content:""; width:8px; height:18px; border-radius:8px;
      background: linear-gradient(180deg, var(--brand) 0%, var(--accent) 100%);
      box-shadow: 0 0 0 3px rgba(37,99,235,.08);
      display:inline-block;
    }

    /* Tables */
    table { width:100%; border-collapse:separate; border-spacing:0; margin-top:6px; font-size:13px; }
    thead th {
      background: linear-gradient(180deg, var(--thead) 0%, #e9efff 100%);
      color:#1f2937; font-weight:700; letter-spacing:.2px;
      border-top:1px solid var(--thead-border);
      border-bottom:1px solid var(--thead-border);
    }
    th, td { padding:10px 10px; text-align:center; }
    tbody td { border-bottom:1px solid var(--line); }
    tbody tr:nth-child(odd){ background: var(--stripe); }
    tbody tr:hover { background:#eef6ff; }
    table { border:1px solid var(--line); border-radius: 10px; overflow: hidden; }
    table thead th:first-child { border-top-left-radius:10px; }
    table thead th:last-child { border-top-right-radius:10px; }

    .muted { color:var(--muted); }

    /* Report Header */
    .report-header {
      border:1px solid var(--line); border-radius: var(--radius);
      padding:16px 22px; margin-bottom:20px; background:#fff; box-shadow: var(--shadow);
    }
    .header-top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .header-top img { max-height:60px; width:auto; }
    .header-center { text-align:center; flex:1; }
    .header-center h1 { margin:0; font-size:24px; font-weight:800; letter-spacing:.2px; }
    .header-center h3 { margin:4px 0 0; font-size:13px; font-weight:500; color:var(--muted); }
    .header-center h2 { margin:8px 0 0; font-size:18px; font-weight:700; color:#111; letter-spacing:.3px; }
    .header-bottom {
      display:flex; flex-wrap:wrap; gap:10px 18px; justify-content:space-between;
      font-size:13px; margin-top:10px; font-weight:600; color:#0b1324;
      border-top:1px dashed var(--line); padding-top:10px;
    }

    /* Report Footer */
    .report-footer {
      border:1px solid var(--line); border-radius: var(--radius);
      padding:16px 20px; margin-top:20px; background:#fff; box-shadow: var(--shadow);
    }
    .footer-section { margin-bottom:16px; }
    .footer-label { font-weight:700; display:block; margin-bottom:6px; color:#111; }
    .remarks-box {
      border:1px dashed var(--brand); min-height:48px; border-radius:10px; background:#fff;
      padding:8px 10px; outline:none;
    }
    .signatures { display:flex; gap:20px; justify-content:space-between; margin-top:14px; }
    .signature { flex:1; }
    .signature-label { font-weight:700; display:block; margin-bottom:10px; }
    .signature-line { border-bottom:2px solid #0b1324; height:34px; border-radius:2px; }

    /* Gauges */
    .gauge-container { display:grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap:12px; }
    .gauge-box { width:100%; height:220px; border:1px solid var(--line); border-radius:12px; padding:6px; background:#fff; }
    @media (max-width: 1100px){
      .gauge-container{ grid-template-columns: repeat(2, minmax(220px, 1fr)); }
    }
    @media (max-width: 560px){
      .gauge-container{ grid-template-columns: 1fr; }
    }

    /* Alerts */
    .error { color:#991b1b; background:#fff1f2; padding:10px 12px; border-radius:10px; border:1px solid #fecaca; margin-top:8px; }

    /* Print-friendly */
    @media print {
      body { background:#fff; }
      .controls { display:none; }
      .card, .report-header, .report-footer { page-break-inside: avoid; box-shadow:none; }
      .container { max-width: 100%; }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- Date Selection -->
  <div class="controls">
    <div>
      <label for="datePicker">Date</label>
      <input id="datePicker" type="date" />
    </div>
    <div>
      <label for="operatorSelect">Operator</label>
      <select id="operatorSelect"><option value="">-- Select Operator --</option></select>
    </div>
    <div style="display:flex; gap:8px; align-items:end;">
      <button id="generateBtn">Generate</button>
      <button id="pdfBtn" class="secondary" title="Download as A4 PDF">Generate PDF</button>
    </div>
    <div class="small" id="status" style="margin-left:auto"></div>
  </div>

  <!-- Report Section -->
  <div id="reportSection" style="display:none;">
    <div class="report-header" id="reportHeader">
      <div class="header-top">
        <img src="PlantwizLogo.png" alt="Plantwiz Logo">
        <div class="header-center">
          <h1>Pima Controls Pvt. Ltd</h1>
          <h3>Block No.298, Nr.Bacha Motors, Sanathal Cross Road, Ahmedabad(382210)</h3>
          <h2>Operator Performance Report</h2>
        </div>
        <img src="PimaLogo.png" alt="Pima Logo">
      </div>
      <div class="header-bottom">
        <span id="headerDate">Date: --</span>
        <span id="headerOperator">Operator Name: --</span>
        <span id="generatedDate">Report Generated ON: --</span>
      </div>
    </div>

    <div id="errorBox" style="display:none" class="error"></div>
    <div id="reportOutput"></div>
    <pre id="debugOutput" style="display:none"></pre>

    <!-- Footer -->
    <div class="report-footer">
      <div class="footer-section">
        <span class="footer-label">Remarks:</span>
        <div class="remarks-box" contenteditable="true" placeholder="Type remarks here..."></div>
      </div>
      <div class="signatures">
        <div class="signature">
          <span class="signature-label">Reviewed By:</span>
          <div class="signature-line"></div>
        </div>
        <div class="signature">
          <span class="signature-label">Checked By:</span>
          <div class="signature-line"></div>
        </div>
      </div>
    </div>
  </div>

</div> <!-- /container -->

  <script>
    /* ---------- Configuration ---------- */
    const DEVICE_ID = "991cf500-661a-11f0-90f1-775fee303094";
    const API_BASE = "https://plantwiz.pimateck.in/api";
    const qs = new URLSearchParams(window.location.search);
    const TOKEN = qs.get('token') || "";

    /* ---------- DOM ---------- */
    const datePicker = document.getElementById('datePicker');
    const operatorSelect = document.getElementById('operatorSelect');
    const btnGenerate = document.getElementById('generateBtn');
    const btnPDF = document.getElementById('pdfBtn');
    const status = document.getElementById('status');
    const reportOutput = document.getElementById('reportOutput');
    const errorBox = document.getElementById('errorBox');
    const debugOutput = document.getElementById('debugOutput');
    const reportSection = document.getElementById('reportSection');

    /* ---------- Helpers ---------- */
    function showError(msg) {
      if (!msg) { errorBox.style.display = 'none'; errorBox.textContent = ''; return; }
      errorBox.style.display = 'block'; errorBox.textContent = msg;
    }
    function setStatus(txt) { status.textContent = txt || ''; }
    function safeNum(v) {
      if (v === undefined || v === null) return NaN;
      const n = typeof v === 'number' ? v : parseFloat(String(v).replace(',', ''));
      return Number.isFinite(n) ? n : NaN;
    }
    function normalizeToMinute(ts) {
      const d = new Date(+ts);
      d.setSeconds(0, 0);
      return d.getTime();
    }

    /* ---------- Telemetry keys ---------- */
    const KEYS_LIST = [
      "SKU","Operator_Name","Downtime_Submit","Downtime_Duration","Downtime_Reason_Code",
      "Machine_Speed","Standard_Speed","Runtime","Downtime","Idletime",
      "deltaperformance","deltaavailability","deltaoee","deltaquality",
      "Good_Production","Planned_Production","Planned_Production_Time",
      "Per_Min_Consumption"
    ];
    const KEYS_PARAM = KEYS_LIST.join(',');

    /* ---------- Fetch timeseries ---------- */
    async function fetchTelemetryForDate(dateStr) {
      if (!TOKEN) throw new Error("Missing token in URL (?token=YOUR_JWT)");
      const start = new Date(dateStr + "T00:00:00").getTime();
      theEnd   = new Date(dateStr + "T23:59:59").getTime();
      const url = `${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${encodeURIComponent(KEYS_PARAM)}&startTs=${start}&endTs=${theEnd}&interval=60000&limit=5000`;
      const res = await fetch(url, { headers: { "X-Authorization": `Bearer ${TOKEN}` } });
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        throw new Error(`Telemetry fetch failed: ${res.status} ${txt}`);
      }
      return res.json();
    }

    /* ---------- Build rows ---------- */
    function buildRowsFromTimeseries(tsObj) {
      const map = new Map();
      Object.entries(tsObj || {}).forEach(([key, arr])=>{
        (arr || []).forEach(p=>{
          const minute = normalizeToMinute(p.ts);
          const row = map.get(minute) || { ts: minute };
          row[key] = p.value;
          map.set(minute, row);
        });
      });
      return Array.from(map.values()).sort((a,b)=>a.ts-b.ts);
    }

    /* ---------- Load operators ---------- */
    async function loadOperators(dateStr) {
      try {
        showError('');
        setStatus('Loading operators…');
        operatorSelect.innerHTML = '<option value="">Loading…</option>';
        const ts = await fetchTelemetryForDate(dateStr);
        const ops = (ts.Operator_Name || []).map(x => String(x.value).trim()).filter(s => s);
        const unique = [...new Set(ops)];
        operatorSelect.innerHTML = '<option value="">-- Select Operator --</option>';
        unique.forEach(op => operatorSelect.appendChild(new Option(op, op)));
        setStatus(unique.length ? `Found ${unique.length} operator(s)` : 'No operators found');
      } catch (err) {
        operatorSelect.innerHTML = '<option value="">-- Select Operator --</option>';
        showError(err.message || String(err));
        setStatus('');
        console.error(err);
      }
    }

    /* ---------- Gauges ---------- */
    function renderGauge(id, value, title) {
      const data = [{
        type: "indicator",
        mode: "gauge+number",
        value: Math.max(0, Math.min(100, Number(value) || 0)),
        title: { text: title, font: { size: 16 } },
        number: { suffix: "%" },
        gauge: {
          axis: { range: [0, 100], tickwidth: 1, tickcolor: "#444" },
          bar: { color: "#2563eb" },
          bgcolor: "white",
          borderwidth: 1,
          bordercolor: "#cbd5e1",
          steps: [
            { range: [0, 50], color: "#fde68a" },
            { range: [50, 75], color: "#facc15" },
            { range: [75, 100], color: "#86efac" }
          ],
          threshold: {
            line: { color: "#111", width: 2 },
            thickness: 0.75,
            value: Math.max(0, Math.min(100, Number(value) || 0))
          }
        }
      }];
      const layout = { width: 260, height: 220, margin: { t: 22, r: 16, l: 16, b: 10 } };
      Plotly.newPlot(id, data, layout, {displayModeBar:false});
    }

    /* ---------- Generate report ---------- */
    async function generateReport() {
      showError('');
      reportOutput.innerHTML = '';
      debugOutput.style.display = 'none';

      const dateStr = datePicker.value;
      const operator = operatorSelect.value;
      if (!dateStr) { showError('Please select a date.'); return; }
      if (!operator) { showError('Please select an operator.'); return; }

      // Show report shell & fill header
      reportSection.style.display = 'block';
      document.getElementById('headerDate').textContent = `Date: ${dateStr}`;
      document.getElementById('headerOperator').textContent = `Operator Name: ${operator}`;
      document.getElementById('generatedDate').textContent = `Report Generated ON: ${new Date().toLocaleString()}`;

      try {
        setStatus('Fetching telemetry and computing report…');
        const ts = await fetchTelemetryForDate(dateStr);
        const rows = buildRowsFromTimeseries(ts);

        // Filter rows for the selected operator
        const opRows = rows.filter(r => {
          const v = r.Operator_Name === undefined || r.Operator_Name === null ? '' : String(r.Operator_Name).trim();
          return v === operator;
        });

        if (opRows.length === 0) {
          reportOutput.innerHTML = `<div class="card"><div class="muted">No records found for ${operator} on ${dateStr}.</div></div>`;
          setStatus('');
          return;
        }

        // Aggregations
        const skuAgg = {};
        let totalRuntime = 0, totalDowntime = 0, totalIdle = 0;
        let actualProduction = 0, goodProduction = 0, plannedProduction = 0, plannedTime = 0;
        let sumPerf = 0, cntPerf = 0;
        let sumAvail = 0, cntAvail = 0;
        let sumOee = 0, cntOee = 0;
        let sumQualityDelta = 0, cntQualityDelta = 0;

        opRows.forEach(r => {
          const sku = (r.SKU && String(r.SKU).trim()) || 'UNSPECIFIED';
          const ms = safeNum(r.Machine_Speed);
          const stdSpeed = safeNum(r.Standard_Speed);
          const rt = safeNum(r.Runtime);
          const dt = safeNum(r.Downtime);
          const it = safeNum(r.Idletime);

          if (!skuAgg[sku]) skuAgg[sku] = { production: 0, runtime: 0, downtime: 0, idletime: 0 };
          skuAgg[sku].production += Number.isFinite(ms) ? ms : 0;
          skuAgg[sku].runtime   += Number.isFinite(rt) ? rt : 0;
          skuAgg[sku].downtime  += Number.isFinite(dt) ? dt : 0;
          skuAgg[sku].idletime  += Number.isFinite(it) ? it : 0;

          totalRuntime   += Number.isFinite(rt) ? rt : 0;
          totalDowntime  += Number.isFinite(dt) ? dt : 0;
          totalIdle      += Number.isFinite(it) ? it : 0;

          actualProduction   += Number.isFinite(ms) ? ms : 0;
          goodProduction     += Number.isFinite(safeNum(r.Good_Production)) ? safeNum(r.Good_Production) : 0;
          plannedProduction  += Number.isFinite(stdSpeed) ? stdSpeed : 0;
          plannedTime         = Number.isFinite(safeNum(r.Planned_Production_Time)) ? safeNum(r.Planned_Production_Time) : plannedTime;

          const dp  = safeNum(r.deltaperformance);  if (Number.isFinite(dp))  { sumPerf += dp;  cntPerf++; }
          const da  = safeNum(r.deltaavailability); if (Number.isFinite(da))  { sumAvail += da; cntAvail++; }
          const doee= safeNum(r.deltaoee);          if (Number.isFinite(doee)){ sumOee += doee; cntOee++; }
          const dq  = safeNum(r.deltaquality);      if (Number.isFinite(dq))  { sumQualityDelta += dq; cntQualityDelta++; }
        });

        const avgPerf = cntPerf ? (sumPerf / cntPerf) : NaN;
        const avgAvail = cntAvail ? (sumAvail / cntAvail) : NaN;
        const avgOee = cntOee ? (sumOee / cntOee) : NaN;
        const avgQualityDelta = cntQualityDelta ? (sumQualityDelta / cntQualityDelta) : NaN;
        const computedQualityPct = actualProduction ? (goodProduction / actualProduction * 100) : NaN;
        const displayQuality = Number.isFinite(avgQualityDelta) ? avgQualityDelta : computedQualityPct;

        // ---------- Build HTML ----------
        let html = '';

        // 1) Production Details (SKU-wise)
        html += `<div class="card">
          <h3 class="section-title">1. Production Details (SKU-wise)</h3>
          <table>
            <thead><tr>
              <th>SKU Name</th>
              <th>Production (Units)</th>
              <th>Runtime (hrs)</th>
              <th>Downtime (hrs)</th>
              <th>Idletime (hrs)</th>
            </tr></thead>
            <tbody>`;
        for (const sku of Object.keys(skuAgg)) {
          const d = skuAgg[sku];
          html += `<tr>
            <td style="font-weight:600">${sku}</td>
            <td>${Number(d.production).toFixed(2)}</td>
            <td>${(Number(d.runtime) / 60).toFixed(2)}</td>
            <td>${(Number(d.downtime) / 60).toFixed(2)}</td>
            <td>${(Number(d.idletime) / 60).toFixed(2)}</td>
          </tr>`;
        }
        html += `</tbody></table></div>`;

        // 2) Machine Performance Summary
        html += `<div class="card">
          <h3 class="section-title">2. Machine Performance Summary</h3>
          <div class="gauge-container">
            <div id="gaugeOEE" class="gauge-box"></div>
            <div id="gaugePerf" class="gauge-box"></div>
            <div id="gaugeAvail" class="gauge-box"></div>
            <div id="gaugeQuality" class="gauge-box"></div>
          </div>
          <table style="margin-top:12px;">
            <thead><tr>
              <th>Planned Production</th>
              <th>Planned Production Time (min)</th>
              <th>Actual Production</th>
              <th>Runtime (hrs)</th>
              <th>Good Production</th>
              <th>Downtime (hrs)</th>
            </tr></thead>
            <tbody><tr>
              <td>${Number.isFinite(plannedProduction) ? plannedProduction.toFixed(0) : '--'}</td>
              <td>${Number.isFinite(plannedTime) ? plannedTime.toFixed(0) : '--'}</td>
              <td>${actualProduction.toFixed(0)}</td>
              <td>${(totalRuntime / 60).toFixed(2)}</td>
              <td>${goodProduction.toFixed(0)}</td>
              <td>${(totalDowntime / 60).toFixed(2)}</td>
            </tr></tbody>
          </table>
        </div>`;

        // 3) Downtime Summary
        const dtByReason = {};
        let failures = 0;
        opRows.forEach(r => {
          const submit = safeNum(r.Downtime_Submit);
          if (submit === 1) {
            const reason = r.Downtime_Reason_Code ? String(r.Downtime_Reason_Code).trim() : 'UNKNOWN';
            let durMin = safeNum(r.Downtime_Duration);
            durMin = Number.isFinite(durMin) ? (durMin / 60) : durMin; // seconds → minutes
            if (!dtByReason[reason]) dtByReason[reason] = { occ: 0, totalMin: 0, mttrSamples: [] };
            dtByReason[reason].occ += 1;
            if (Number.isFinite(durMin)) {
              dtByReason[reason].totalMin += durMin;
              dtByReason[reason].mttrSamples.push(durMin);
            }
            failures++;
          }
        });
        Object.values(dtByReason).forEach(obj => {
          obj.mttr = obj.mttrSamples.length ? (obj.mttrSamples.reduce((a,b)=>a+b,0)/obj.mttrSamples.length) : NaN;
          obj.mtbf = obj.occ ? (totalRuntime / obj.occ) : NaN;
        });
        const overallMTTR = failures ? (Object.values(dtByReason).reduce((a,b)=>a+b.totalMin,0) / failures) : NaN;
        const overallMTBF = failures ? (totalRuntime / failures) : NaN;

        let dtRows = '';
        Object.entries(dtByReason).forEach(([reason,obj],i)=>{
          const dtId = `D-${String(101+i).padStart(3,'0')}`;
          dtRows += `<tr>
            <td style="font-weight:600">${dtId}</td>
            <td style="text-align:left">${reason}</td>
            <td>${Number(obj.totalMin).toFixed(0)}</td>
            <td>${obj.occ}</td>
            <td>${Number.isFinite(obj.mtbf)? obj.mtbf.toFixed(0):'--'}</td>
            <td>${Number.isFinite(obj.mttr)? obj.mttr.toFixed(0):'--'}</td>
          </tr>`;
        });

        html += `
          <div class="card">
            <h3 class="section-title">3. Alarms & Downtimes During Operation</h3>
            <table>
              <thead><tr>
                <th>Downtime ID</th>
                <th style="text-align:left">Downtime Reason</th>
                <th>Downtime Duration (min)</th>
                <th>No. of Times</th>
                <th>MTBF (min)</th>
                <th>MTTR (min)</th>
              </tr></thead>
              <tbody>
                ${dtRows || '<tr><td colspan="6" class="muted">No downtime events</td></tr>'}
              </tbody>
            </table>
            <div class="small" style="margin-top:8px; color:#0b1324; font-weight:600;">
              Overall Operator MTBF: <span style="color:var(--brand)">${Number.isFinite(overallMTBF)? overallMTBF.toFixed(0):'--'}</span> min
              &nbsp; | &nbsp;
              Overall Operator MTTR: <span style="color:var(--brand)">${Number.isFinite(overallMTTR)? overallMTTR.toFixed(0):'--'}</span> min
            </div>
          </div>`;

        // 4) Energy Consumption & Losses
        let runtimeKwh = 0, downtimeKwh = 0, idleKwh = 0, totalKwh = 0;
        opRows.forEach(r => {
          const cons = safeNum(r.Per_Min_Consumption);
          if (!Number.isFinite(cons)) return;
          totalKwh += cons;
          const rtFlag = safeNum(r.Runtime) === 1;
          const dtFlag = safeNum(r.Downtime) === 1;
          const idFlag = safeNum(r.Idletime) === 1;
          if (rtFlag) runtimeKwh += cons;
          else if (dtFlag) downtimeKwh += cons;
          else if (idFlag) idleKwh += cons;
        });
        const bucketSum = runtimeKwh + downtimeKwh + idleKwh;
        if (Number.isFinite(totalKwh) && Math.abs(totalKwh - bucketSum) > 1e-6) {
          totalKwh = bucketSum;
        }
        const pct = (val, total) => (Number.isFinite(val) && total > 0) ? ((val/total)*100) : NaN;
        const runtimePct = pct(runtimeKwh, totalKwh);
        const downtimePct = pct(downtimeKwh, totalKwh);
        const idlePct = pct(idleKwh, totalKwh);

        html += `
          <div class="card">
            <h3 class="section-title">4. Energy Consumption & Losses</h3>
            <table>
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Energy Consumed (kWh)</th>
                  <th>% of Total Consumption</th>
                  <th>Remarks</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="text-align:left; font-weight:600">Runtime Consumption</td>
                  <td>${Number(runtimeKwh).toFixed(2)}</td>
                  <td>${Number.isFinite(runtimePct) ? runtimePct.toFixed(1) + '%' : '--'}</td>
                  <td>Productive Energy Use</td>
                </tr>
                <tr>
                  <td style="text-align:left; font-weight:600">Downtime Consumption</td>
                  <td>${Number(downtimeKwh).toFixed(2)}</td>
                  <td>${Number.isFinite(downtimePct) ? downtimePct.toFixed(1) + '%' : '--'}</td>
                  <td>Energy Lost during Downtime</td>
                </tr>
                <tr>
                  <td style="text-align:left; font-weight:600">Idle Consumption</td>
                  <td>${Number(idleKwh).toFixed(2)}</td>
                  <td>${Number.isFinite(idlePct) ? idlePct.toFixed(1) + '%' : '--'}</td>
                  <td>Standby Loss</td>
                </tr>
                <tr>
                  <th>Total</th>
                  <th>${Number(totalKwh).toFixed(2)}</th>
                  <th>100%</th>
                  <th>-</th>
                </tr>
              </tbody>
            </table>
          </div>`;

        // 5) Supervisor Insights
        const qualityPct = Number.isFinite(displayQuality) ? displayQuality.toFixed(1) : '--';
        const qualityText = `Quality Performance: ${operator} maintained a strong quality output of ${qualityPct}%, ensuring minimal defects despite operational challenges.`;

        let downtimeText = 'Downtime Analysis: No downtime events recorded.';
        if (Object.keys(dtByReason).length) {
          let top = Object.entries(dtByReason).sort((a,b)=>b[1].occ - a[1].occ)[0];
          const reason = top[0];
          const occ = top[1].occ;
          const mtbfTop = Number.isFinite(top[1].mtbf)? top[1].mtbf.toFixed(0):'--';
          const mttrTop = Number.isFinite(top[1].mttr)? top[1].mttr.toFixed(0):'--';
          downtimeText = `Downtime Analysis: Majority of downtime events were due to ${reason} (${occ} occurrences). MTBF = ${mtbfTop} min | MTTR = ${mttrTop} min. However, recurrence indicates the need for preventive maintenance checks.`;
        }

        const oeePct = Number.isFinite(avgOee) ? avgOee.toFixed(1) : '--';
        const oeeText = `OEE Review: Current OEE stands at ${oeePct}%, which is fair but can be further improved, particularly by addressing downtime reduction in SKU-B production.`;

        html += `<div class="card">
          <h3 class="section-title">5. Supervisor Insights</h3>
          <p style="margin:.25rem 0">a: ${qualityText}</p>
          <p style="margin:.25rem 0">b: ${downtimeText}</p>
          <p style="margin:.25rem 0">c: ${oeeText}</p>
        </div>`;

        // 6) Recommendations
        let recTextA = 'Preventive Maintenance: No downtime data available.';
        let recTextB = 'Training Support: No downtime data available.';
        if (Object.keys(dtByReason).length) {
          let top = Object.entries(dtByReason).sort((a,b)=>b[1].occ - a[1].occ)[0];
          const reason = top[0];
          recTextA = `Preventive Maintenance: Schedule periodic checks for systems to reduce recurring '${reason}' issues.`;
          recTextB = `Training Support: Provide ${operator} with quick-resolution protocols for handling '${reason}' issues, reducing reliance on maintenance.`;
        }

        let recTextC = 'SKU Focus: No SKU downtime data available.';
        if (Object.keys(skuAgg).length) {
          let skuDowntimeSorted = Object.entries(skuAgg).sort((a,b)=>b[1].downtime - a[1].downtime)[0];
          const skuName = skuDowntimeSorted[0];
          recTextC = `SKU Focus: Investigate ${skuName} production processes to identify specific bottlenecks causing downtime and optimize machine settings/preparations.`;
        }

        let weakest = '';
        let val = Infinity;
        if (Number.isFinite(avgAvail) && avgAvail < val) { weakest = 'Availability'; val = avgAvail; }
        if (Number.isFinite(avgPerf) && avgPerf < val) { weakest = 'Performance'; val = avgPerf; }
        if (Number.isFinite(displayQuality) && displayQuality < val) { weakest = 'Quality'; val = displayQuality; }
        const oeeImproveTarget = Number.isFinite(avgOee)? (avgOee+5).toFixed(1):'82';
        const recTextD = `OEE Improvement Plan: Current bottleneck is ${weakest || '—'}. Set a target to improve OEE from ${Number.isFinite(avgOee)? avgOee.toFixed(1):'77.7'}% to ${oeeImproveTarget}%+ by improving ${weakest || 'the weakest KPI'}.`;

        html += `<div class="card">
          <h3 class="section-title">6. Recommendations</h3>
          <ul style="margin:0 0 0 16px; padding:0; line-height:1.5;">
            <li>${recTextA}</li>
            <li>${recTextB}</li>
            <li>${recTextC}</li>
            <li>${recTextD}</li>
          </ul>
        </div>`;

        // Render built HTML
        reportOutput.innerHTML = html;

        // Render gauges with computed values
        renderGauge('gaugeOEE', Number.isFinite(avgOee) ? avgOee : 0, 'OEE');
        renderGauge('gaugePerf', Number.isFinite(avgPerf) ? avgPerf : 0, 'Performance');
        renderGauge('gaugeAvail', Number.isFinite(avgAvail) ? avgAvail : 0, 'Availability');
        renderGauge('gaugeQuality', Number.isFinite(displayQuality) ? displayQuality : 0, 'Quality');

        debugOutput.style.display = 'block';
        debugOutput.textContent = `Averages computed from counts:
deltaperformance → count=${cntPerf}
deltaavailability → count=${cntAvail}
deltaoee → count=${cntOee}
deltaquality → count=${cntQualityDelta}`;

        setStatus(`Report ready — rows used: ${opRows.length}`);
      } catch (err) {
        showError(err.message || String(err));
        setStatus('');
        console.error(err);
      }
    }

    /* ---------- PDF Export (A4) ---------- */
    async function generatePDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4'); // 595.28 x 841.89 pt
        const report = document.querySelector('.container'); // capture with margins

        const canvas = await html2canvas(report, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
        const imgData = canvas.toDataURL('image/png');

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const imgWidth = pageWidth;
        const imgHeight = canvas.height * imgWidth / canvas.width;

        let heightLeft = imgHeight;
        let position = 0;

        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        const dateStr = (document.getElementById('headerDate').textContent || '').replace('Date: ','') || 'Report';
        const operator = (document.getElementById('headerOperator').textContent || '').replace('Operator Name: ','') || 'Operator';
        doc.save(`Operator_Performance_Report_${operator}_${dateStr}.pdf`);
      } catch (e) {
        console.error(e);
        showError('Failed to generate PDF. See console for details.');
      }
    }

    /* ---------- Events ---------- */
    datePicker.addEventListener('change', () => {
      setStatus('');
      showError('');
      const date = datePicker.value;
      if (!date) return;
      loadOperators(date);
    });

    btnGenerate.addEventListener('click', generateReport);
    btnPDF.addEventListener('click', generatePDF);

    (function setToday(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      datePicker.value = `${y}-${m}-${day}`;
      if (datePicker.value) loadOperators(datePicker.value).catch(()=>{});
    })();
  </script>
</body>
</html>
