<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Operator Performance Report</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Gauges -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 18px; background:#f7fafc; color:#111; }
    h2 { margin: 0 0 12px; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    input[type="date"], select { padding:8px 10px; border-radius:6px; border:1px solid #d1d5db; }
    button { padding:9px 12px; background:#2563eb; color:#fff; border:0; border-radius:8px; cursor:pointer; font-weight:600; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .card { background: #fff; padding:14px; border-radius:10px; border:1px solid #e6e9ef; margin-bottom:14px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
    th, td { padding:8px; border:1px solid #999; text-align:center; }
    th { background:#f8fafc; font-weight:700; }
    .muted { color:#6b7280; font-size:13px; }
    .small { font-size:12px; color:#6b7280; }
    pre { background:#f3f4f6; padding:8px; border-radius:6px; overflow:auto; max-height:180px; }
    .error { color:#991b1b; background:#fff1f2; padding:8px; border-radius:6px; border:1px solid #fecaca; margin-top:8px; }

    /* Header */
    .report-header { border:1px solid #000; border-radius:6px; padding:10px 20px; margin-bottom:20px; background:#fff; }
    .header-top { display:flex; justify-content:space-between; align-items:center; }
    .header-top img { max-height:60px; width:auto; }
    .header-center { text-align:center; flex:1; }
    .header-center h1 { margin:0; font-size:22px; font-weight:bold; }
    .header-center h3 { margin:4px 0 0; font-size:14px; font-weight:normal; }
    .header-center h2 { margin:6px 0 0; font-size:18px; font-weight:bold; }
    .header-bottom { display:flex; justify-content:space-between; font-size:13px; margin-top:6px; font-weight:bold; }

    /* Footer */
    .report-footer { border:1px solid #000; border-radius:6px; padding:10px 20px; margin-top:20px; background:#fff; }
    .footer-section { margin-bottom:16px; }
    .footer-label { font-weight:bold; display:block; margin-bottom:6px; }
    .remarks-box { border:1px solid #000; min-height:40px; border-radius:4px; background:#fff; padding:4px; }
    .signatures { display:flex; justify-content:space-between; margin-top:20px; }
    .signature { width:45%; }
    .signature-label { font-weight:bold; display:block; margin-bottom:6px; }
    .signature-line { border-bottom:1px solid #000; height:30px; margin-top:5px; }

    /* Gauges */
    .gauge-container { display:grid; grid-template-columns: repeat(4, minmax(200px, 1fr)); gap:10px; }
    .gauge-box { width:100%; height:210px; }
    @media (max-width: 1100px){
      .gauge-container{ grid-template-columns: repeat(2, minmax(200px, 1fr)); }
    }
    @media (max-width: 560px){
      .gauge-container{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Date Selection -->
  <div class="controls">
    <label for="datePicker">Date</label>
    <input id="datePicker" type="date" />
    <label for="operatorSelect">Operator</label>
    <select id="operatorSelect"><option value="">-- Select Operator --</option></select>
    <button id="generateBtn">Generate</button>
    <div id="status" class="small muted" style="margin-left:12px"></div>
  </div>

  <!-- Report Section -->
  <div id="reportSection" style="display:none;">
    <div class="report-header" id="reportHeader">
      <div class="header-top">
        <img src="PlantwizLogo.png" alt="Plantwiz Logo">
        <div class="header-center">
          <h1>Pima Controls Pvt. Ltd</h1>
          <h3>Block No.298, Nr.Bacha Motors, Sanathal Cross Road, Ahmedabad(382210)</h3>
          <h2>Operator Performance Report</h2>
        </div>
        <img src="PimaLogo.png" alt="Pima Logo">
      </div>
      <div class="header-bottom">
        <span id="headerDate">Date: --</span>
        <span id="headerOperator">Operator Name: --</span>
        <span id="generatedDate">Report Generated ON: --</span>
      </div>
    </div>

    <div id="errorBox" style="display:none" class="error"></div>
    <div id="reportOutput"></div>
    <pre id="debugOutput" style="display:none"></pre>

    <!-- Footer -->
    <div class="report-footer">
      <div class="footer-section">
        <span class="footer-label">Remarks:</span>
        <div class="remarks-box" contenteditable="true"></div>
      </div>
      <div class="signatures">
        <div class="signature">
          <span class="signature-label">Reviewed By:</span>
          <div class="signature-line"></div>
        </div>
        <div class="signature">
          <span class="signature-label">Checked By:</span>
          <div class="signature-line"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Configuration ---------- */
    const DEVICE_ID = "991cf500-661a-11f0-90f1-775fee303094";
    const API_BASE = "https://plantwiz.pimateck.in/api";
    const qs = new URLSearchParams(window.location.search);
    const TOKEN = qs.get('token') || "";

    /* ---------- DOM ---------- */
    const datePicker = document.getElementById('datePicker');
    const operatorSelect = document.getElementById('operatorSelect');
    const btnGenerate = document.getElementById('generateBtn');
    const status = document.getElementById('status');
    const reportOutput = document.getElementById('reportOutput');
    const errorBox = document.getElementById('errorBox');
    const debugOutput = document.getElementById('debugOutput');
    const reportSection = document.getElementById('reportSection');

    /* ---------- Helpers ---------- */
    function showError(msg) {
      if (!msg) { errorBox.style.display = 'none'; errorBox.textContent = ''; return; }
      errorBox.style.display = 'block'; errorBox.textContent = msg;
    }
    function setStatus(txt) { status.textContent = txt || ''; }
    function safeNum(v) {
      if (v === undefined || v === null) return NaN;
      const n = typeof v === 'number' ? v : parseFloat(String(v).replace(',', ''));
      return Number.isFinite(n) ? n : NaN;
    }
    function normalizeToMinute(ts) {
      const d = new Date(+ts);
      d.setSeconds(0, 0);
      return d.getTime();
    }

    /* ---------- Telemetry keys ---------- */
    const KEYS_LIST = [
      "SKU","Operator_Name","Downtime_Submit","Downtime_Duration","Downtime_Reason_Code",
      "Machine_Speed","Standard_Speed","Runtime","Downtime","Idletime",
      "deltaperformance","deltaavailability","deltaoee","deltaquality",
      "Good_Production","Planned_Production","Planned_Production_Time",
      "Per_Min_Consumption"
    ];
    const KEYS_PARAM = KEYS_LIST.join(',');

    /* ---------- Fetch timeseries ---------- */
    async function fetchTelemetryForDate(dateStr) {
      if (!TOKEN) throw new Error("Missing token in URL (?token=YOUR_JWT)");
      const start = new Date(dateStr + "T00:00:00").getTime();
      const end = new Date(dateStr + "T23:59:59").getTime();
      const url = `${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${encodeURIComponent(KEYS_PARAM)}&startTs=${start}&endTs=${end}&interval=60000&limit=5000`;
      const res = await fetch(url, { headers: { "X-Authorization": `Bearer ${TOKEN}` } });
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        throw new Error(`Telemetry fetch failed: ${res.status} ${txt}`);
      }
      return res.json();
    }

    /* ---------- Build rows ---------- */
    function buildRowsFromTimeseries(tsObj) {
      const map = new Map();
      Object.entries(tsObj || {}).forEach(([key, arr])=>{
        (arr || []).forEach(p=>{
          const minute = normalizeToMinute(p.ts);
          const row = map.get(minute) || { ts: minute };
          row[key] = p.value;
          map.set(minute, row);
        });
      });
      return Array.from(map.values()).sort((a,b)=>a.ts-b.ts);
    }

    /* ---------- Load operators ---------- */
    async function loadOperators(dateStr) {
      try {
        showError('');
        setStatus('Loading operators…');
        operatorSelect.innerHTML = '<option value="">Loading…</option>';
        const ts = await fetchTelemetryForDate(dateStr);
        const ops = (ts.Operator_Name || []).map(x => String(x.value).trim()).filter(s => s);
        const unique = [...new Set(ops)];
        operatorSelect.innerHTML = '<option value="">-- Select Operator --</option>';
        unique.forEach(op => operatorSelect.appendChild(new Option(op, op)));
        setStatus(unique.length ? `Found ${unique.length} operator(s)` : 'No operators found');
      } catch (err) {
        operatorSelect.innerHTML = '<option value="">-- Select Operator --</option>';
        showError(err.message || String(err));
        setStatus('');
        console.error(err);
      }
    }

    /* ---------- Gauges ---------- */
    function renderGauge(id, value, title) {
      const data = [{
        type: "indicator",
        mode: "gauge+number",
        value: Math.max(0, Math.min(100, Number(value) || 0)),
        title: { text: title, font: { size: 16 } },
        number: { suffix: "%" },
        gauge: {
          axis: { range: [0, 100], tickwidth: 1, tickcolor: "#444" },
          bar: { color: "#2563eb" },
          bgcolor: "white",
          borderwidth: 1,
          bordercolor: "#aaa",
          steps: [
            { range: [0, 50], color: "#fde68a" },
            { range: [50, 75], color: "#facc15" },
            { range: [75, 100], color: "#86efac" }
          ],
          threshold: {
            line: { color: "#111", width: 2 },
            thickness: 0.75,
            value: Math.max(0, Math.min(100, Number(value) || 0))
          }
        }
      }];
      const layout = { width: 260, height: 210, margin: { t: 22, r: 16, l: 16, b: 10 } };
      Plotly.newPlot(id, data, layout, {displayModeBar:false});
    }

    /* ---------- Generate report ---------- */
    async function generateReport() {
      showError('');
      reportOutput.innerHTML = '';
      debugOutput.style.display = 'none';

      const dateStr = datePicker.value;
      const operator = operatorSelect.value;
      if (!dateStr) { showError('Please select a date.'); return; }
      if (!operator) { showError('Please select an operator.'); return; }

      // Show report shell & fill header
      reportSection.style.display = 'block';
      document.getElementById('headerDate').textContent = `Date: ${dateStr}`;
      document.getElementById('headerOperator').textContent = `Operator Name: ${operator}`;
      document.getElementById('generatedDate').textContent = `Report Generated ON: ${new Date().toLocaleString()}`;

      try {
        setStatus('Fetching telemetry and computing report…');
        const ts = await fetchTelemetryForDate(dateStr);
        const rows = buildRowsFromTimeseries(ts);

        // Filter rows for the selected operator
        const opRows = rows.filter(r => {
          const v = r.Operator_Name === undefined || r.Operator_Name === null ? '' : String(r.Operator_Name).trim();
          return v === operator;
        });

        if (opRows.length === 0) {
          reportOutput.innerHTML = `<div class="card"><div class="muted">No records found for ${operator} on ${dateStr}.</div></div>`;
          setStatus('');
          return;
        }

        // Aggregations
        const skuAgg = {};
        let totalRuntime = 0, totalDowntime = 0, totalIdle = 0;
        let actualProduction = 0, goodProduction = 0, plannedProduction = 0, plannedTime = 0;
        let sumPerf = 0, cntPerf = 0;
        let sumAvail = 0, cntAvail = 0;
        let sumOee = 0, cntOee = 0;
        let sumQualityDelta = 0, cntQualityDelta = 0;

        opRows.forEach(r => {
          const sku = (r.SKU && String(r.SKU).trim()) || 'UNSPECIFIED';
          const ms = safeNum(r.Machine_Speed);
          const stdSpeed = safeNum(r.Standard_Speed);
          const rt = safeNum(r.Runtime);
          const dt = safeNum(r.Downtime);
          const it = safeNum(r.Idletime);

          if (!skuAgg[sku]) skuAgg[sku] = { production: 0, runtime: 0, downtime: 0, idletime: 0 };
          skuAgg[sku].production += Number.isFinite(ms) ? ms : 0;
          skuAgg[sku].runtime   += Number.isFinite(rt) ? rt : 0;
          skuAgg[sku].downtime  += Number.isFinite(dt) ? dt : 0;
          skuAgg[sku].idletime  += Number.isFinite(it) ? it : 0;

          totalRuntime   += Number.isFinite(rt) ? rt : 0;
          totalDowntime  += Number.isFinite(dt) ? dt : 0;
          totalIdle      += Number.isFinite(it) ? it : 0;

          actualProduction   += Number.isFinite(ms) ? ms : 0;
          goodProduction     += Number.isFinite(safeNum(r.Good_Production)) ? safeNum(r.Good_Production) : 0;
          plannedProduction  += Number.isFinite(stdSpeed) ? stdSpeed : 0;
          plannedTime         = Number.isFinite(safeNum(r.Planned_Production_Time)) ? safeNum(r.Planned_Production_Time) : plannedTime;

          const dp  = safeNum(r.deltaperformance);  if (Number.isFinite(dp))  { sumPerf += dp;  cntPerf++; }
          const da  = safeNum(r.deltaavailability); if (Number.isFinite(da))  { sumAvail += da; cntAvail++; }
          const doee= safeNum(r.deltaoee);          if (Number.isFinite(doee)){ sumOee += doee; cntOee++; }
          const dq  = safeNum(r.deltaquality);      if (Number.isFinite(dq))  { sumQualityDelta += dq; cntQualityDelta++; }
        });

        const avgPerf = cntPerf ? (sumPerf / cntPerf) : NaN;
        const avgAvail = cntAvail ? (sumAvail / cntAvail) : NaN;
        const avgOee = cntOee ? (sumOee / cntOee) : NaN;
        const avgQualityDelta = cntQualityDelta ? (sumQualityDelta / cntQualityDelta) : NaN;
        const computedQualityPct = actualProduction ? (goodProduction / actualProduction * 100) : NaN;
        const displayQuality = Number.isFinite(avgQualityDelta) ? avgQualityDelta : computedQualityPct;

        // ---------- Build HTML ----------
        let html = '';

        // 1) Production Details (SKU-wise)
        html += `<div class="card"><h3>1. Production Details (SKU-wise)</h3>`;
        html += `<table><thead><tr><th>SKU Name</th><th>Production (Units)</th><th>Runtime (hrs)</th><th>Downtime (hrs)</th><th>Idletime (hrs)</th></tr></thead><tbody>`;
        for (const sku of Object.keys(skuAgg)) {
          const d = skuAgg[sku];
          html += `<tr>
            <td>${sku}</td>
            <td>${Number(d.production).toFixed(2)}</td>
            <td>${(Number(d.runtime) / 60).toFixed(2)}</td>
            <td>${(Number(d.downtime) / 60).toFixed(2)}</td>
            <td>${(Number(d.idletime) / 60).toFixed(2)}</td>
          </tr>`;
        }
        html += `</tbody></table></div>`;

        // 2) Machine Performance Summary (Gauges + details table)
        html += `<div class="card"><h3>2. Machine Performance Summary</h3>
          <div class="gauge-container">
            <div id="gaugeOEE" class="gauge-box"></div>
            <div id="gaugePerf" class="gauge-box"></div>
            <div id="gaugeAvail" class="gauge-box"></div>
            <div id="gaugeQuality" class="gauge-box"></div>
          </div>
          <table style="margin-top:10px;">
            <thead><tr>
              <th>Planned Production</th><th>Planned Production Time (min)</th><th>Actual Production</th>
              <th>Runtime (hrs)</th><th>Good Production</th><th>Downtime (hrs)</th>
            </tr></thead>
            <tbody><tr>
              <td>${Number.isFinite(plannedProduction) ? plannedProduction.toFixed(0) : '--'}</td>
              <td>${Number.isFinite(plannedTime) ? plannedTime.toFixed(0) : '--'}</td>
              <td>${actualProduction.toFixed(0)}</td>
              <td>${(totalRuntime / 60).toFixed(2)}</td>
              <td>${goodProduction.toFixed(0)}</td>
              <td>${(totalDowntime / 60).toFixed(2)}</td>
            </tr></tbody>
          </table>
        </div>`;

        // 3) Downtime Summary (seconds → minutes)
        const dtByReason = {};
        let failures = 0;
        opRows.forEach(r => {
          const submit = safeNum(r.Downtime_Submit);
          if (submit === 1) {
            const reason = r.Downtime_Reason_Code ? String(r.Downtime_Reason_Code).trim() : 'UNKNOWN';
            let durMin = safeNum(r.Downtime_Duration);
            durMin = Number.isFinite(durMin) ? (durMin / 60) : durMin; // seconds → minutes
            if (!dtByReason[reason]) dtByReason[reason] = { occ: 0, totalMin: 0, mttrSamples: [] };
            dtByReason[reason].occ += 1;
            if (Number.isFinite(durMin)) {
              dtByReason[reason].totalMin += durMin;
              dtByReason[reason].mttrSamples.push(durMin);
            }
            failures++;
          }
        });
        Object.values(dtByReason).forEach(obj => {
          obj.mttr = obj.mttrSamples.length ? (obj.mttrSamples.reduce((a,b)=>a+b,0)/obj.mttrSamples.length) : NaN;
          obj.mtbf = obj.occ ? (totalRuntime / obj.occ) : NaN; // runtime minutes / occurrences
        });
        const overallMTTR = failures ? (Object.values(dtByReason).reduce((a,b)=>a+b.totalMin,0) / failures) : NaN;
        const overallMTBF = failures ? (totalRuntime / failures) : NaN;

        let dtRows = '';
        Object.entries(dtByReason).forEach(([reason,obj],i)=>{
          const dtId = `D-${String(101+i).padStart(3,'0')}`;
          dtRows += `<tr>
            <td>${dtId}</td>
            <td>${reason}</td>
            <td>${Number(obj.totalMin).toFixed(0)}</td>
            <td>${obj.occ}</td>
            <td>${Number.isFinite(obj.mtbf)? obj.mtbf.toFixed(0):'--'}</td>
            <td>${Number.isFinite(obj.mttr)? obj.mttr.toFixed(0):'--'}</td>
          </tr>`;
        });

        html += `
          <div class="card">
            <h3>3. Alarms & Downtimes During Operation</h3>
            <h4>Downtime Summary</h4>
            <table>
              <thead><tr>
                <th>Downtime ID</th>
                <th>Downtime Reason</th>
                <th>Downtime Duration (min)</th>
                <th>No. of Times</th>
                <th>MTBF (min)</th>
                <th>MTTR (min)</th>
              </tr></thead>
              <tbody>
                ${dtRows || '<tr><td colspan="6" class="muted">No downtime events</td></tr>'}
              </tbody>
            </table>
            <div class="small muted" style="margin-top:6px">
              Overall Operator MTBF: ${Number.isFinite(overallMTBF)? overallMTBF.toFixed(0):'--'} min
              &nbsp; | &nbsp;
              Overall Operator MTTR: ${Number.isFinite(overallMTTR)? overallMTTR.toFixed(0):'--'} min
            </div>
          </div>`;

        // 4) Energy Consumption & Losses
        let runtimeKwh = 0, downtimeKwh = 0, idleKwh = 0, totalKwh = 0;
        opRows.forEach(r => {
          const cons = safeNum(r.Per_Min_Consumption);
          if (!Number.isFinite(cons)) return;
          totalKwh += cons;
          const rtFlag = safeNum(r.Runtime) === 1;
          const dtFlag = safeNum(r.Downtime) === 1;
          const idFlag = safeNum(r.Idletime) === 1;
          if (rtFlag) runtimeKwh += cons;
          else if (dtFlag) downtimeKwh += cons;
          else if (idFlag) idleKwh += cons;
        });
        const bucketSum = runtimeKwh + downtimeKwh + idleKwh;
        if (Number.isFinite(totalKwh) && Math.abs(totalKwh - bucketSum) > 1e-6) {
          totalKwh = bucketSum; // align so % add to 100
        }
        const pct = (val, total) => (Number.isFinite(val) && total > 0) ? ((val/total)*100) : NaN;
        const runtimePct = pct(runtimeKwh, totalKwh);
        const downtimePct = pct(downtimeKwh, totalKwh);
        const idlePct = pct(idleKwh, totalKwh);

        html += `
          <div class="card">
            <h3>4. Energy Consumption & Losses</h3>
            <table>
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Energy Consumed (kWh)</th>
                  <th>% of Total Consumption</th>
                  <th>Remarks</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Runtime Consumption</td>
                  <td>${Number(runtimeKwh).toFixed(2)}</td>
                  <td>${Number.isFinite(runtimePct) ? runtimePct.toFixed(1) + '%' : '--'}</td>
                  <td>Productive Energy Use</td>
                </tr>
                <tr>
                  <td>Downtime Consumption</td>
                  <td>${Number(downtimeKwh).toFixed(2)}</td>
                  <td>${Number.isFinite(downtimePct) ? downtimePct.toFixed(1) + '%' : '--'}</td>
                  <td>Energy Lost during Downtime</td>
                </tr>
                <tr>
                  <td>Idle Consumption</td>
                  <td>${Number(idleKwh).toFixed(2)}</td>
                  <td>${Number.isFinite(idlePct) ? idlePct.toFixed(1) + '%' : '--'}</td>
                  <td>Standby Loss</td>
                </tr>
                <tr>
                  <th>Total</th>
                  <th>${Number(totalKwh).toFixed(2)}</th>
                  <th>100%</th>
                  <th>-</th>
                </tr>
              </tbody>
            </table>
          </div>`;

        // 5) Supervisor Insights
        const qualityPct = Number.isFinite(displayQuality) ? displayQuality.toFixed(1) : '--';
        const qualityText = `Quality Performance: ${operator} maintained a strong quality output of ${qualityPct}%, ensuring minimal defects despite operational challenges.`;

        let downtimeText = 'Downtime Analysis: No downtime events recorded.';
        if (Object.keys(dtByReason).length) {
          let top = Object.entries(dtByReason).sort((a,b)=>b[1].occ - a[1].occ)[0];
          const reason = top[0];
          const occ = top[1].occ;
          const mtbfTop = Number.isFinite(top[1].mtbf)? top[1].mtbf.toFixed(0):'--';
          const mttrTop = Number.isFinite(top[1].mttr)? top[1].mttr.toFixed(0):'--';
          downtimeText = `Downtime Analysis: Majority of downtime events were due to ${reason} (${occ} occurrences). MTBF = ${mtbfTop} min | MTTR = ${mttrTop} min. However, recurrence indicates the need for preventive maintenance checks.`;
        }

        const oeePct = Number.isFinite(avgOee) ? avgOee.toFixed(1) : '--';
        const oeeText = `OEE Review: Current OEE stands at ${oeePct}%, which is fair but can be further improved, particularly by addressing downtime reduction in SKU-B production.`;

        html += `<div class="card">
          <h3>5. Supervisor Insights</h3>
          <p>a: ${qualityText}</p>
          <p>b: ${downtimeText}</p>
          <p>c: ${oeeText}</p>
        </div>`;

        // 6) Recommendations
        let recTextA = 'Preventive Maintenance: No downtime data available.';
        let recTextB = 'Training Support: No downtime data available.';
        if (Object.keys(dtByReason).length) {
          let top = Object.entries(dtByReason).sort((a,b)=>b[1].occ - a[1].occ)[0];
          const reason = top[0];
          recTextA = `Preventive Maintenance: Schedule periodic checks for systems to reduce recurring '${reason}' issues.`;
          recTextB = `Training Support: Provide ${operator} with quick-resolution protocols for handling '${reason}' issues, reducing reliance on maintenance.`;
        }

        let recTextC = 'SKU Focus: No SKU downtime data available.';
        if (Object.keys(skuAgg).length) {
          let skuDowntimeSorted = Object.entries(skuAgg).sort((a,b)=>b[1].downtime - a[1].downtime)[0];
          const skuName = skuDowntimeSorted[0];
          recTextC = `SKU Focus: Investigate ${skuName} production processes to identify specific bottlenecks causing downtime and optimize machine settings/preparations.`;
        }

        let weakest = '';
        let val = Infinity;
        if (Number.isFinite(avgAvail) && avgAvail < val) { weakest = 'Availability'; val = avgAvail; }
        if (Number.isFinite(avgPerf) && avgPerf < val) { weakest = 'Performance'; val = avgPerf; }
        if (Number.isFinite(displayQuality) && displayQuality < val) { weakest = 'Quality'; val = displayQuality; }
        const oeeImproveTarget = Number.isFinite(avgOee)? (avgOee+5).toFixed(1):'82';
        const recTextD = `OEE Improvement Plan: Current bottleneck is ${weakest || '—'}. Set a target to improve OEE from ${Number.isFinite(avgOee)? avgOee.toFixed(1):'77.7'}% to ${oeeImproveTarget}%+ by improving ${weakest || 'the weakest KPI'}.`;

        html += `<div class="card">
          <h3>6. Recommendations</h3>
          <p>a: ${recTextA}</p>
          <p>b: ${recTextB}</p>
          <p>c: ${recTextC}</p>
          <p>d: ${recTextD}</p>
        </div>`;

        // Render built HTML
        reportOutput.innerHTML = html;

        // Render gauges with computed values
        renderGauge('gaugeOEE', Number.isFinite(avgOee) ? avgOee : 0, 'OEE');
        renderGauge('gaugePerf', Number.isFinite(avgPerf) ? avgPerf : 0, 'Performance');
        renderGauge('gaugeAvail', Number.isFinite(avgAvail) ? avgAvail : 0, 'Availability');
        renderGauge('gaugeQuality', Number.isFinite(displayQuality) ? displayQuality : 0, 'Quality');

        debugOutput.style.display = 'block';
        debugOutput.textContent = `Averages computed from counts:
deltaperformance → count=${cntPerf}
deltaavailability → count=${cntAvail}
deltaoee → count=${cntOee}
deltaquality → count=${cntQualityDelta}`;

        setStatus(`Report ready — rows used: ${opRows.length}`);
      } catch (err) {
        showError(err.message || String(err));
        setStatus('');
        console.error(err);
      }
    }

    /* ---------- Events ---------- */
    datePicker.addEventListener('change', () => {
      setStatus('');
      showError('');
      const date = datePicker.value;
      if (!date) return;
      loadOperators(date);
    });

    btnGenerate.addEventListener('click', generateReport);

    (function setToday(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      datePicker.value = `${y}-${m}-${day}`;
      if (datePicker.value) loadOperators(datePicker.value).catch(()=>{});
    })();
  </script>
</body>
</html>
