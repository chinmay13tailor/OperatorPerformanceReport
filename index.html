<!DOCTYPE html>
<html>
<head>
  <title>Operator Performance Report</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, input, button { padding: 8px; margin: 10px; }
  </style>
</head>
<body>
  <h2>Operator Performance Report</h2>
  <label for="date">Select Date:</label>
  <input type="date" id="datePicker">
  
  <label for="operatorSelect">Select Operator:</label>
  <select id="operatorSelect">
    <option value="">-- Select Operator --</option>
  </select>

  <button id="generateBtn">Generate Report</button>

  <pre id="output"></pre>

  <script>
    const deviceId = "991cf500-661a-11f0-90f1-775fee303094";
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    const datePicker = document.getElementById("datePicker");
    const operatorSelect = document.getElementById("operatorSelect");
    const output = document.getElementById("output");

    // Normalize timestamp to minute
    function normalizeToMinute(timestamp) {
      let date = new Date(timestamp);
      date.setSeconds(0, 0);
      return date.getTime();
    }

    // Fetch telemetry for the selected date
    async function fetchTelemetry(date) {
      let start = new Date(date + "T00:00:00").getTime();
      let end = new Date(date + "T23:59:59").getTime();
      const response = await fetch(
        `https://plantwiz.pimateck.in/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=Operator_Name,SKU,Runtime,Downtime,Machine_Speed,Standard_Speed&startTs=${start}&endTs=${end}`,
        {
          headers: { "X-Authorization": `Bearer ${token}` }
        }
      );
      return await response.json();
    }

    // Populate operator dropdown after date selection
    datePicker.addEventListener("change", async () => {
      let date = datePicker.value;
      if (!date) return;
      
      output.textContent = "Fetching operators...";
      let telemetry = await fetchTelemetry(date);

      let operatorSet = new Set();
      if (telemetry.Operator_Name) {
        telemetry.Operator_Name.forEach(item => {
          let normalizedTime = normalizeToMinute(item.ts);
          operatorSet.add(item.value);
        });
      }

      operatorSelect.innerHTML = '<option value="">-- Select Operator --</option>';
      operatorSet.forEach(op => {
        let option = document.createElement("option");
        option.value = op;
        option.textContent = op;
        operatorSelect.appendChild(option);
      });

      output.textContent = "Operators loaded. Please select one.";
    });

    // Generate report for selected operator
    document.getElementById("generateBtn").addEventListener("click", async () => {
      let date = datePicker.value;
      let operator = operatorSelect.value;
      if (!date || !operator) {
        output.textContent = "Please select a date and an operator.";
        return;
      }

      output.textContent = `Generating report for ${operator} on ${date}...`;
      let telemetry = await fetchTelemetry(date);

      // Group telemetry by minute
      let groupedData = {};
      ["SKU","Runtime","Downtime","Machine_Speed","Standard_Speed","Operator_Name"].forEach(key => {
        if (!telemetry[key]) return;
        telemetry[key].forEach(entry => {
          let minute = normalizeToMinute(entry.ts);
          if (!groupedData[minute]) groupedData[minute] = {};
          groupedData[minute][key] = entry.value;
        });
      });

      // Filter by operator
      let operatorData = Object.entries(groupedData)
        .filter(([minute, data]) => data.Operator_Name === operator)
        .map(([minute, data]) => ({ time: new Date(parseInt(minute)).toLocaleTimeString(), ...data }));

      output.textContent = JSON.stringify(operatorData, null, 2);
    });
  </script>
</body>
</html>
